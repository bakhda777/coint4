# Журнал прогонов оптимизации (2026-02-12)

Цель: проверить гипотезу восстановления Sharpe для капитала `$1000` на extended OOS `2023-05-01 -> 2024-04-30` через:
- смягчение фильтров (`min_correlation`, `coint_pvalue_threshold`) для роста числа торгуемых пар;
- ослабление нелинейности sizing (`min_notional_per_trade`, `max_notional_per_trade`);
- умеренный рост `max_pairs`/`max_active_positions` при сохранении `tlow` логики.

## Валидация перед запуском
- Проверка консистентности Sharpe для последних `$1000` очередей: `Sharpe consistency OK (28 run(s))`.
- Проверка артефактов для очередей `20260131_budget1000_*`: обязательные файлы (`strategy_metrics.csv`, `trade_statistics.csv`, `equity_curve.csv`, `daily_pnl.csv`) присутствуют.
- В глобальном rollup есть 3 старых `completed` без метрик (группа `20260119_relaxed8_nokpss_u250_turnover_stress`), на текущую серию это не влияет.

## Новая очередь
- Очередь: `coint4/artifacts/wfa/aggregate/20260212_budget1000_tlow_extended_sharpe_recover10/run_queue.csv`
- Конфиги: `coint4/configs/budget_20260212_1000_tlow_extended_sharpe_recover10/*.yaml`
- Размер: 10 прогонов (`5` вариантов × `holdout/stress`)

### Матрица параметров (варианты r1-r5)
| variant | z | ms | corr | pvalue | max_pairs | max_active_positions | risk | min_notional | max_notional |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| r1 | 1.25 | 0.35 | 0.38 | 0.25 | 15 | 15 | 0.0175 | 10 | 25 |
| r2 | 1.25 | 0.35 | 0.36 | 0.25 | 18 | 15 | 0.0175 | 10 | 30 |
| r3 | 1.30 | 0.35 | 0.38 | 0.25 | 15 | 15 | 0.0175 | 10 | 25 |
| r4 | 1.25 | 0.30 | 0.36 | 0.30 | 20 | 16 | 0.0150 | 8 | 30 |
| r5 | 1.20 | 0.30 | 0.40 | 0.22 | 15 | 15 | 0.0175 | 10 | 40 |

## Запуск на удалённом сервере
- Целевой хост: `85.198.90.128` (только для тяжёлых WFA).
- Команда очереди:
  - `COINT_FILTER_BACKEND=threads PYTHONPATH=src ./.venv/bin/python scripts/optimization/run_wfa_queue.py --queue artifacts/wfa/aggregate/20260212_budget1000_tlow_extended_sharpe_recover10/run_queue.csv --parallel 8`
- Локальная dry-run валидация очереди: `10` run(s), все `planned`.
- Фактический статус после запуска: `completed` для всех `10/10` прогонов.

## Критерии отбора после завершения
- Primary: максимизировать `min(Sharpe_holdout, Sharpe_stress)`.
- Гейты: `total_trades >= 500`, `total_pairs_traded >= 50`, `max_drawdown_abs >= -250`.
- Cost gate: `stress cost_ratio <= 0.5` (при положительном `total_pnl`).

## Результаты (10 прогонов)
| variant | kind | sharpe | pnl | max_dd | cost_ratio | trades | pairs |
|---|---|---:|---:|---:|---:|---:|---:|
| r1 | holdout | 0.255 | 7.86 | -282.69 | 11.26 | 2563 | 44 |
| r1 | stress | -0.121 | -56.26 | -289.28 | — | 2563 | 44 |
| r2 | holdout | 0.501 | 52.75 | -339.20 | 1.99 | 3001 | 52 |
| r2 | stress | 0.117 | -24.62 | -344.77 | — | 3001 | 52 |
| r3 | holdout | 0.455 | 43.21 | -293.13 | 1.92 | 2481 | 44 |
| r3 | stress | 0.081 | -20.47 | -311.10 | — | 2481 | 44 |
| r4 | holdout | 1.871 | 343.31 | -343.73 | 0.27 | 3271 | 53 |
| r4 | stress | 1.482 | 254.89 | -355.54 | 0.62 | 3271 | 53 |
| r5 | holdout | 1.258 | 199.49 | -326.89 | 0.44 | 2644 | 48 |
| r5 | stress | 0.878 | 123.38 | -335.93 | 1.24 | 2644 | 48 |

## Итог
- Лучший по `min(Sharpe_holdout, Sharpe_stress)`: `r4` (`1.482`), также это единственный вариант с устойчиво положительным stress PnL.
- Плюс: удалось поднять число пар до `53` (в прошлой серии было `36`), что подтверждает гипотезу про bottleneck в фильтрах/caps.
- Минус: ни один вариант не прошёл риск-гейт по просадке (`max_dd >= -250`), а `r4` не прошёл cost-gate (`stress cost_ratio 0.62 > 0.5`).
- Вывод: Sharpe улучшили, но профиль риска для `$1000` в extended OOS остаётся слишком агрессивным; дальше нужен отдельный DD/cost downshift вокруг `r4`.

## Extra sweep: min_notional без ограничений (12 прогонов)
- Запрос: «максимальный Sharpe любой ценой, стартовый капитал `$1000`».
- Очередь: `coint4/artifacts/wfa/aggregate/20260212_budget1000_sharpe_unbounded_minnot/run_queue.csv`
- Конфиги: `coint4/configs/budget_20260212_1000_sharpe_unbounded_minnot/*.yaml`
- Размер: 12 прогонов (`6` вариантов `u1-u6` × `holdout/stress`)
- Статус: `12/12 completed`

### Матрица параметров (u1-u6)
| variant | z | ms | corr | pvalue | max_pairs | max_active_positions | risk | min_notional | max_notional |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| u1 | 1.25 | 0.30 | 0.36 | 0.30 | 20 | 16 | 0.0150 | 0.5 | 1000 |
| u2 | 1.25 | 0.30 | 0.36 | 0.30 | 20 | 16 | 0.0150 | 1.0 | 1000 |
| u3 | 1.25 | 0.30 | 0.36 | 0.30 | 20 | 16 | 0.0150 | 2.0 | 1000 |
| u4 | 1.25 | 0.30 | 0.34 | 0.35 | 24 | 18 | 0.0125 | 1.0 | 1000 |
| u5 | 1.20 | 0.25 | 0.34 | 0.35 | 24 | 18 | 0.0200 | 1.0 | 500 |
| u6 | 1.20 | 0.25 | 0.34 | 0.35 | 24 | 18 | 0.0150 | 5.0 | 1000 |

### Результаты (12 прогонов)
| variant | kind | sharpe | pnl | max_dd | cost_ratio | trades | pairs |
|---|---|---:|---:|---:|---:|---:|---:|
| u1 | holdout | 1.870 | 343.31 | -343.73 | 0.27 | 3271 | 53 |
| u1 | stress | 1.482 | 254.89 | -355.54 | 0.62 | 3271 | 53 |
| u2 | holdout | 1.870 | 343.31 | -343.73 | 0.27 | 3271 | 53 |
| u2 | stress | 1.482 | 254.89 | -355.54 | 0.62 | 3271 | 53 |
| u3 | holdout | 1.870 | 343.31 | -343.73 | 0.27 | 3271 | 53 |
| u3 | stress | 1.482 | 254.89 | -355.54 | 0.62 | 3271 | 53 |
| u4 | holdout | 1.461 | 247.49 | -288.18 | 0.39 | 3895 | 58 |
| u4 | stress | 1.076 | 165.67 | -289.07 | 1.01 | 3895 | 58 |
| u5 | holdout | 2.771 | 1122.42 | -467.99 | 0.16 | 4047 | 58 |
| u5 | stress | 2.421 | 912.62 | -470.57 | 0.34 | 4047 | 58 |
| u6 | holdout | 2.775 | 806.80 | -343.12 | 0.16 | 4047 | 58 |
| u6 | stress | 2.425 | 668.69 | -346.67 | 0.34 | 4047 | 58 |

### Выводы по min_notional
- В зоне `u1-u3` изменение `min_notional=0.5/1/2` дало идентичные метрики: в этих параметрах `min_notional` не является лимитирующим.
- Новый максимум Sharpe получен в `u6`:
  - holdout Sharpe `2.775`
  - stress Sharpe `2.425`
  - `min(holdout, stress) = 2.425` (лучший результат на `$1000` в текущей extended OOS ветке).
- `u5` и `u6` резко лучше `u1-u4` из-за комбинированного сдвига режима (`z=1.20`, `ms=0.25`, более мягкие corr/pvalue, больше пар), а не только за счёт `min_notional`.
- Если цель только максимум Sharpe (без ограничений DD), текущий лидер: `u6`.

## Extra sweep: signal sprint around `u6` (10 прогонов)
- Запрос: ещё поднять Sharpe при фиксированном стартовом капитале `$1000` и `min_notional=5` (без обрезаний по мелким сделкам).
- Очередь: `coint4/artifacts/wfa/aggregate/20260212_budget1000_sharpe_signal_sprint1/run_queue.csv`
- Конфиги: `coint4/configs/budget_20260212_1000_sharpe_signal_sprint1/*.yaml`
- Размер: 10 прогонов (`5` вариантов `v1-v5` × `holdout/stress`)
- Запуск: `85.198.90.128`, статус `10/10 completed`

### Валидация записи результатов
- `Sharpe consistency OK (10 run(s))` для всей очереди `signal_sprint1`.
- Обязательные артефакты (`strategy_metrics.csv`, `trade_statistics.csv`, `equity_curve.csv`, `daily_pnl.csv`, `run.log`, `run.commands.log`) присутствуют в `10/10` run directories.
- В `run.log` нет `Traceback`/`ERROR`/`Exception`.

### Матрица параметров (v1-v5)
| variant | z | exit | ms | corr | pvalue | max_pairs | max_active_positions | risk | min_notional | max_notional |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| v1 | 1.15 | 0.08 | 0.20 | 0.34 | 0.35 | 24 | 18 | 0.0150 | 5 | 1000 |
| v2 | 1.15 | 0.08 | 0.25 | 0.34 | 0.35 | 24 | 18 | 0.0150 | 5 | 1000 |
| v3 | 1.20 | 0.08 | 0.20 | 0.34 | 0.35 | 24 | 18 | 0.0150 | 5 | 1000 |
| v4 | 1.20 | 0.10 | 0.25 | 0.32 | 0.40 | 32 | 18 | 0.0150 | 5 | 1000 |
| v5 | 1.10 | 0.10 | 0.25 | 0.32 | 0.40 | 32 | 18 | 0.0150 | 5 | 1000 |

### Результаты (10 прогонов)
| variant | kind | sharpe | pnl | max_dd | cost_ratio | trades | pairs |
|---|---|---:|---:|---:|---:|---:|---:|
| v1 | holdout | 3.338 | 1150.58 | -327.39 | 0.13 | 4204 | 58 |
| v1 | stress | 3.007 | 986.38 | -313.70 | 0.26 | 4204 | 58 |
| v2 | holdout | 3.222 | 1055.74 | -310.93 | 0.14 | 4199 | 58 |
| v2 | stress | 2.880 | 897.68 | -302.34 | 0.28 | 4199 | 58 |
| v3 | holdout | 2.905 | 860.20 | -344.06 | 0.15 | 4049 | 58 |
| v3 | stress | 2.555 | 718.63 | -347.41 | 0.31 | 4049 | 58 |
| v4 | holdout | 1.585 | 415.59 | -467.90 | 0.44 | 5509 | 71 |
| v4 | stress | 1.173 | 263.84 | -476.99 | 1.17 | 5509 | 71 |
| v5 | holdout | 0.776 | 130.81 | -612.52 | 1.29 | 5903 | 71 |
| v5 | stress | 0.380 | -6.09 | -607.87 | — | 5903 | 71 |

### Итог по sprint1
- Новый лидер по `min(Sharpe_holdout, Sharpe_stress)`: `v1` c `3.007` (`3.338/3.007` holdout/stress).
- Прирост к прошлому лидеру `u6` (`2.425` stress Sharpe): `+0.582` по robust-метрике `min_sharpe`.
- Режим `v1-v3` (58 пар, ~4.0-4.2k сделок) дал лучший Sharpe и PnL; расширение до 71 пар (`v4-v5`) ухудшило Sharpe и резко подняло DD/cost_ratio.
- Если цель действительно «максимальный Sharpe любой ценой» при `$1000`, текущий лучший конфиг: `v1`.

## Extra sweep: signal sprint2 (local search around `v1`, 10 прогонов)
- Очередь: `coint4/artifacts/wfa/aggregate/20260212_budget1000_sharpe_signal_sprint2/run_queue.csv`
- Конфиги: `coint4/configs/budget_20260212_1000_sharpe_signal_sprint2/*.yaml`
- Размер: 10 прогонов (`5` вариантов `s1-s5` × `holdout/stress`)
- Статус: `10/10 completed`
- Валидация: `Sharpe consistency OK (10 run(s))`
- Note: в части прогонов были `ERROR/Traceback` при инициализации memory-mapped кэша `.cache/consolidated_prices.parquet` (коррупция из-за параллельных записей); результаты при этом корректно записались (полный набор артефактов), а в коде добавлен lock + atomic replace + range-keyed cache filename.

### Матрица параметров (s1-s5)
Все параметры, кроме signal-части, фиксированы как в `v1` (universe/filters/sizing/limits).

| variant | z | exit | ms | hold | cd |
|---|---:|---:|---:|---:|---:|
| s1 | 1.10 | 0.08 | 0.18 | 300 | 300 |
| s2 | 1.10 | 0.07 | 0.16 | 300 | 300 |
| s3 | 1.12 | 0.07 | 0.16 | 300 | 300 |
| s4 | 1.14 | 0.07 | 0.18 | 300 | 300 |
| s5 | 1.10 | 0.08 | 0.16 | 240 | 240 |

### Результаты (10 прогонов)
| variant | kind | sharpe | pnl | max_dd | cost_ratio | trades | pairs |
|---|---|---:|---:|---:|---:|---:|---:|
| s1 | holdout | 2.166 | 619.08 | -470.06 | 0.21 | 4351 | 58 |
| s1 | stress | 1.815 | 481.59 | -488.43 | 0.47 | 4351 | 58 |
| s2 | holdout | 1.101 | 205.99 | -499.48 | 0.55 | 4310 | 58 |
| s2 | stress | 0.691 | 99.07 | -510.35 | 1.95 | 4310 | 58 |
| s3 | holdout | 1.283 | 253.40 | -475.60 | 0.45 | 4257 | 58 |
| s3 | stress | 0.874 | 144.61 | -483.32 | 1.34 | 4257 | 58 |
| s4 | holdout | 1.757 | 396.14 | -422.76 | 0.30 | 4200 | 58 |
| s4 | stress | 1.365 | 279.83 | -431.69 | 0.73 | 4200 | 58 |
| s5 | holdout | 2.467 | 656.73 | -464.57 | 0.20 | 4464 | 58 |
| s5 | stress | 2.067 | 514.32 | -463.73 | 0.44 | 4464 | 58 |

### Итог по sprint2
- Ни один вариант `s1-s5` не улучшил `v1`; лучший robust `min_sharpe` у `s5` = `2.067` (хуже `v1` = `3.007`).
- Понижение `z` и `min_spread_move_sigma` относительно `v1` в этом extended OOS ухудшает Sharpe и увеличивает DD → локальный оптимум в зоне `z≈1.15`, `ms≈0.20`, `hold/cd=300`.
