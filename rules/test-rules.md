---
type: "agent_requested"
description: "Core principles for writing high-quality pytest tests for this project. Focus on performance (fast/slow markers), isolation (unit/serial), determinism (seed), and preventing lookahead bias."
---
–ù–∞—à–∞ —Ü–µ–ª—å: –ù–∞–¥–µ–∂–Ω—ã–µ, –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: unit > integration > e2e.
üëë –ó–æ–ª–æ—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (TL;DR ‚Äî —ç—Ç–æ –∑–∞–∫–æ–Ω)
–°–∫–æ—Ä–æ—Å—Ç—å: Unit-—Ç–µ—Å—Ç ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (< 1 —Å–µ–∫).
–ú–∞—Ä–∫–µ—Ä—ã: @pytest.mark.slow –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (> 2-3 —Å–µ–∫). @pytest.mark.serial –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞—Ç—å (–ø–∏—à—É—Ç –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª/–∫—ç—à). –ú–∞—Ä–∫–µ—Ä—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.
–î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º: seed –¥–ª—è random –∏ numpy —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –∏ –æ–¥–∏–Ω —Ä–∞–∑ –≤ conftest.py. –ù–µ –¥—É–±–ª–∏—Ä—É–π —Ñ–∏–∫—Å–∞—Ü–∏—é seed –≤ –∫–æ–¥–µ —Ç–µ—Å—Ç–æ–≤. –≠—Ç–æ –Ω–∞—à —Å—Ç–∞–Ω–¥–∞—Ä—Ç.
–ù–∏–∫–∞–∫–∏—Ö "–≤–∑–≥–ª—è–¥–æ–≤ –≤ –±—É–¥—É—â–µ–µ": –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–º–µ–Ω—Ç–∞ t –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–æ t-1. –ü—Ä–æ–≤–µ—Ä—è–π —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏.
–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ: –ò–º—è —Ç–µ—Å—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É test_feature_when_condition_then_result.
–ö—Ä–∞—Å–Ω—ã–π —Ç–µ—Å—Ç: –≠—Ç–æ —Å–∏–≥–Ω–∞–ª –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–æ–¥–∞, –∞ –Ω–µ –∫ –æ—Å–ª–∞–±–ª–µ–Ω–∏—é —Ç–µ—Å—Ç–∞. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–π –¥–æ–ø—É—Å–∫–∏ (pytest.approx) –∏ –Ω–µ —É–¥–∞–ª—è–π –∞—Å—Å–µ—Ä—Ç—ã, —á—Ç–æ–±—ã —Ç–µ—Å—Ç "–ø–æ–∑–µ–ª–µ–Ω–µ–ª".
üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç (–ö–∞–∫ –¥–µ–ª–∞—Ç—å)
–î–∞–Ω–Ω—ã–µ –∏ –∏–∑–æ–ª—è—Ü–∏—è:
–ò—Å–ø–æ–ª—å–∑—É–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã: tiny_prices_df –¥–ª—è unit-—Ç–µ—Å—Ç–æ–≤, small_prices_df –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö.
–í—Å–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—É tmp_path. –ù–µ –æ—Å—Ç–∞–≤–ª—è–π –º—É—Å–æ—Ä.
–ù–∏–∫–∞–∫–∏—Ö time.sleep. –ú–æ–∫–∏—Ä—É–π –≤—Ä–µ–º—è.
–ú–æ–∫–∏—Ä—É–π –≤—Å—ë —Ç—è–∂–µ–ª–æ–µ –∏ –≤–Ω–µ—à–Ω–µ–µ (I/O, —Å–µ—Ç—å, —Å–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è) —á–µ—Ä–µ–∑ @patch.
–°—Ç–∏–ª—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ:
–û–¥–∏–Ω —Ç–µ—Å—Ç ‚Äî –æ–¥–∏–Ω –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç. –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–π —á–µ—Ä–µ–∑ @pytest.mark.parametrize.
–ù–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏. –ò–∑–±–µ–≥–∞–π "–º–∞–≥–∏—á–µ—Å–∫–∏—Ö" —á–∏—Å–µ–ª –∏ —Å—Ç—Ä–æ–∫. –ï—Å–ª–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞, –≤—ã–Ω–æ—Å–∏ –µ–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –ø–æ–Ω—è—Ç–Ω—ã–º –∏–º–µ–Ω–µ–º (EXPECTED_VALUE = 5).
–ü–æ–Ω—è—Ç–Ω—ã–µ –∞—Å—Å–µ—Ä—Ç—ã: –î–ª—è float –∏—Å–ø–æ–ª—å–∑—É–π pytest.approx() –∏–ª–∏ np.isclose(). –î–ª—è DataFrame ‚Äî pd.testing.assert_frame_equal(). –ù–µ –ø–∏—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ assert, –µ—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ pytest –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
–ü–æ–ª–Ω–æ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:
–ü—Ä–æ–≤–µ—Ä—è–π –æ—à–∏–±–∫–∏. –¢–µ—Å—Ç–∏—Ä—É–π –Ω–µ —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ –∏ –æ–∂–∏–¥–∞–µ–º—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é pytest.raises.
–ü—Ä–æ–≤–µ—Ä—è–π –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏. –í–∫–ª—é—á–∞–π –≤ —Ç–µ—Å—Ç—ã —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –Ω—É–ª—è–º–∏, –ø—É—Å—Ç—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏/DataFrame, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏/–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
–¢–µ—Å—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Optuna, Numba/BLAS):
Optuna: n_trials –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º (3-5). –ò—Å–ø–æ–ª—å–∑—É–π RandomSampler –∏ tmp_path –¥–ª—è storage. –ú–∞—Ä–∫–∏—Ä—É–π @pytest.mark.serial.
Numba/BLAS: –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ (pytest -n auto) –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤ —á–µ—Ä–µ–∑ os.environ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ CPU.
üßê –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ (–Ω–∞—à–∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è)
–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã (_method): –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä—è–º—É—é. –ò—Ö —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π API –∫–ª–∞—Å—Å–∞.
–°–ª–æ–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã: –ï—Å–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ª–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–∞ —Å–ª–æ–∂–Ω—ã, –¥–æ–±–∞–≤—å –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π #, –æ–±—ä—è—Å–Ω—è—é—â–∏–π, —á—Ç–æ —Å–∏–º—É–ª–∏—Ä—É–µ—Ç—Å—è –∏ –ø–æ—á–µ–º—É.
¬´–ü–ª–∞–≤–∞—é—â–∏–π¬ª (flaky) —Ç–µ—Å—Ç: –ù–µ —É–¥–∞–ª—è–π. –ü–æ–º–µ—Ç—å –º–∞—Ä–∫–µ—Ä–æ–º @pytest.mark.flaky –∏ —Å–æ–æ–±—â–∏ –º–Ω–µ –æ–± —ç—Ç–æ–º. –ï–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –º–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.