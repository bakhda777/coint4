#!/bin/bash
# CI/CD pipeline tests - –±—ã—Å—Ç—Ä—ã–µ + –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

set -e

echo "üöÄ CI/CD PIPELINE TESTS"
echo "======================="
echo "–¶–µ–ª—å: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è CI/CD –±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
echo "–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <5 –º–∏–Ω—É—Ç"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –°–Ω–∞—á–∞–ª–∞ smoke —Ç–µ—Å—Ç—ã
echo "1Ô∏è‚É£ –ó–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–æ–≤..."
time pytest -m smoke --maxfail=1 -q --tb=short
echo "‚úÖ Smoke —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
echo ""

# –ë—ã—Å—Ç—Ä—ã–µ unit —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–∏—Å–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)
echo "2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö unit —Ç–µ—Å—Ç–æ–≤ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)..."
time pytest -n auto -m "fast and not serial and not integration and not slow" --maxfail=5 -q --tb=short --durations=5
echo "‚úÖ –ë—ã—Å—Ç—Ä—ã–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
echo ""

# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ smoke –≤–µ—Ä—Å–∏–∏)
echo "3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–æ–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."
time pytest -m "critical_fixes and smoke" --maxfail=3 -q --tb=short
echo "‚úÖ Smoke —Ç–µ—Å—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–π–¥–µ–Ω—ã"
echo ""

# –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
echo "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –≤–∞–∂–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)..."
time pytest tests/test_critical_fixes_consolidated.py tests/test_smoke.py --maxfail=2 -q --tb=short
echo "‚úÖ –í–∞–∂–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
echo ""

echo "üéâ CI/CD PIPELINE TESTS –ó–ê–í–ï–†–®–ï–ù–´ –£–°–ü–ï–®–ù–û!"
echo "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞."
