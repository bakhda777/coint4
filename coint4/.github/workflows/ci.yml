name: CI Smoke Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # –ú–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç –¥–ª—è –≤—Å–µ–≥–æ job
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
      fail-fast: false  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ—Å—Ç—ã –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è Python —É–ø–∞–ª–∞
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Shallow clone –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Poetry
      uses: actions/cache@v3
      with:
        path: |
          ~/.local/share/pypoetry
          ~/.cache/pypoetry/cache
          ~/.cache/pypoetry/artifacts
        key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          poetry-${{ runner.os }}-${{ matrix.python-version }}-
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-${{ matrix.python-version }}-
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        poetry install --no-dev
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        poetry install --only=dev --only=test
    
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
      run: |
        mkdir -p data_downloaded/year=2024/month=01
        # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π parquet —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        python -c "
        import pandas as pd
        import numpy as np
        from pathlib import Path
        
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è smoke —Ç–µ—Å—Ç–æ–≤
        dates = pd.date_range('2024-01-01', periods=1000, freq='15min')
        data = pd.DataFrame({
            'timestamp': dates,
            'symbol': ['BTC'] * 500 + ['ETH'] * 500,
            'close': np.concatenate([
                40000 + np.random.randn(500) * 100,  # BTC
                2500 + np.random.randn(500) * 50     # ETH
            ])
        })
        
        Path('data_downloaded/year=2024/month=01').mkdir(parents=True, exist_ok=True)
        data.to_parquet('data_downloaded/year=2024/month=01/data_part_01.parquet')
        print('‚úì –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã')
        "
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
        ls -la
        echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è src:"
        ls -la src/ || echo "‚ö†Ô∏è  src/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è configs:"
        ls -la configs/ || echo "‚ö†Ô∏è  configs/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è tests:"
        ls -la tests/ || echo "‚ö†Ô∏è  tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è scripts:"
        ls -la scripts/ || echo "‚ö†Ô∏è  scripts/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    
    - name: Lint –∫–æ–¥ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
      run: |
        # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        poetry run ruff check src/optimiser/ src/coint2/core/ --select=E,F
      continue-on-error: true  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º CI –∏–∑-–∑–∞ lint –æ—à–∏–±–æ–∫
    
    - name: –ó–∞–ø—É—Å–∫ CI Smoke Tests
      timeout-minutes: 5  # Smoke —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∑–∞ 5 –º–∏–Ω—É—Ç
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ CI Smoke Tests..."
        poetry run python scripts/ci_smoke.py
      env:
        PYTHONPATH: ${{ github.workspace }}/src
        NUMBA_DISABLE_JIT: 0  # –í–∫–ª—é—á–∞–µ–º JIT –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    
    - name: –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö pytest smoke —Ç–µ—Å—Ç–æ–≤
      timeout-minutes: 3
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö pytest smoke —Ç–µ—Å—Ç–æ–≤..."
        poetry run pytest -m smoke -v --tb=short --maxfail=5
      continue-on-error: true  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å pytest
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
      run: |
        echo "‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
        python -c "
        import yaml
        from pathlib import Path
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º main_2024.yaml
        config_path = Path('configs/main_2024.yaml')
        if config_path.exists():
            with open(config_path) as f:
                config = yaml.safe_load(f)
            print('‚úì main_2024.yaml –∑–∞–≥—Ä—É–∂–µ–Ω')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            if config.get('walk_forward', {}).get('gap_minutes') == 15:
                print('‚úì gap_minutes = 15')
            else:
                print('‚ö†Ô∏è  gap_minutes != 15')
                
        else:
            print('‚ö†Ô∏è  main_2024.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º search space
        search_path = Path('configs/search_spaces/fast.yaml')
        if search_path.exists():
            print('‚úì fast.yaml –Ω–∞–π–¥–µ–Ω')
        else:
            print('‚ö†Ô∏è  fast.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω')
        "
    
    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ coverage (–µ—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è)
      if: success() && github.event_name != 'pull_request'
      run: |
        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è coverage –æ—Ç—á–µ—Ç–∞..."
        poetry run pytest tests/unit/test_smoke.py --cov=src --cov-report=xml || true
      continue-on-error: true
    
    - name: –ó–∞–≥—Ä—É–∑–∫–∞ coverage –≤ Codecov
      if: success() && github.event_name != 'pull_request'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º CI –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å codecov
    
    - name: –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      if: always()  # –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É
      run: |
        echo "üìã –°–í–û–î–ö–ê CI SMOKE TESTS"
        echo "=========================="
        echo "Python –≤–µ—Ä—Å–∏—è: ${{ matrix.python-version }}"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Runner: ${{ runner.os }}"
        echo "–°—Ç–∞—Ç—É—Å: ${{ job.status }}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        du -sh . || true
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å
        free -h || true
        
        echo "‚úÖ CI Smoke Tests –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–∞—Ö
  fast-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: smoke-tests
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Poetry
      uses: snok/install-poetry@v1
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ)
      run: |
        poetry install --only=main,test
    
    - name: –ë—ã—Å—Ç—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
      run: |
        echo "‚ö° –ë—ã—Å—Ç—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è PR..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        poetry run python -m py_compile scripts/ci_smoke.py
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã
        poetry run python -c "
        try:
            from src.coint2.utils.config import load_config
            from src.optimiser.fast_objective import FastWalkForwardObjective
            print('‚úì –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç')
        except Exception as e:
            print(f'‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤: {e}')
            exit(1)
        "
        
        echo "‚úÖ –ë—ã—Å—Ç—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞"

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  notify:
    runs-on: ubuntu-latest
    needs: [smoke-tests, fast-validation]
    if: always() && github.event_name != 'pull_request'
    
    steps:
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
      run: |
        echo "üîî CI –†–ï–ó–£–õ–¨–¢–ê–¢–´"
        echo "================"
        echo "Smoke tests: ${{ needs.smoke-tests.result }}"
        echo "Fast validation: ${{ needs.fast-validation.result }}"
        
        if [[ "${{ needs.smoke-tests.result }}" == "success" ]]; then
          echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞"
        else
          echo "‚ùå –ï—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã"
        fi